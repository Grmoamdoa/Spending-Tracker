<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spending Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .budget-pill {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: inline-block;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .budget-pill:hover {
            background: rgba(255,255,255,0.3);
        }

        .budget-pill.over-budget {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .budget-pill.watch-spending {
            background: #f39c12;
            border-color: #d68910;
        }

        .budget-pill.on-track {
            background: #27ae60;
            border-color: #229954;
        }

        .nav {
            display: flex;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .content {
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .list-item {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .list-item h3 {
            margin-bottom: 8px;
            color: #333;
        }

        .list-meta {
            color: #666;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .item-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .item-details {
            color: #666;
            font-size: 14px;
        }

        .item-total {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .item-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            flex: 1;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .photo-item {
            text-align: center;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .photo-item-label {
            font-size: 12px;
            color: #666;
            line-height: 1.2;
        }

        .fullscreen-photo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .fullscreen-photo img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .chart-container {
            margin: 20px 0;
            height: 300px;
            position: relative;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .content {
                padding: 15px;
            }
            
            .input-row {
                flex-direction: column;
            }
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .debug {
            font-size: 12px;
            color: #999;
            margin: 10px 0;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="header-title">Spending Tracker</h1>
            <div id="budget-pill" class="budget-pill" onclick="showBudgetModal()">
                No Budget Set
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="showTab('lists')">üìù Lists</div>
            <div class="nav-item" onclick="showTab('photos')">üì∑ Photos</div>
            <div class="nav-item" onclick="showTab('analytics')">üìä Analytics</div>
            <div class="nav-item" onclick="showTab('export')">üíæ Data</div>
        </div>

        <div class="content">
            <!-- Lists Tab -->
            <div id="lists-tab">
                <div id="lists-view">
                    <div id="lists-container"></div>
                    <button class="btn" onclick="showCreateListModal()">+ Create New List</button>
                    <button class="btn btn-secondary" onclick="showGroupsModal()">üìÅ Manage Groups</button>
                </div>

                <div id="list-detail-view" class="hidden">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="backToLists()">‚Üê Back</button>
                        <button class="btn" onclick="showAddItemModal()">+ Add Item</button>
                    </div>
                    <div id="items-container"></div>
                </div>
            </div>

            <!-- Photos Tab -->
            <div id="photos-tab" class="hidden">
                <div id="photos-container" class="photo-grid"></div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="hidden">
                <div id="stats-container" class="stats-grid"></div>
                <div class="chart-controls">
                    <button class="btn btn-secondary" onclick="showFilterModal()">üéØ Filter Lists</button>
                    <button class="btn btn-secondary" onclick="toggleChartType()">üìä Toggle Chart</button>
                </div>
                <div class="chart-container">
                    <canvas id="spending-chart"></canvas>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export-tab" class="hidden">
                <div class="export-section">
                    <h3>Export Data</h3>
                    <button class="btn" onclick="exportCurrentList()">Export Current List (JSON)</button>
                    <button class="btn" onclick="exportAllData()">Export All Data (JSON)</button>
                    <button class="btn" onclick="showCSVExportModal()">Export CSV</button>
                </div>
                <div class="export-section">
                    <h3>Import Data</h3>
                    <input type="file" id="import-file" accept=".json" onchange="importData()" style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Choose File to Import</button>
                </div>
                <div class="export-section">
                    <h3>Data Management</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                    <div class="debug" id="debug-info"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Modal</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="fullscreen-photo" class="fullscreen-photo hidden" onclick="closeFullscreen()">
        <img id="fullscreen-img" src="" alt="">
    </div>

    <script>
        // Global state
        let currentTab = 'lists';
        let currentListId = null;
        let currentView = 'lists'; // 'lists' or 'list-detail'
        let lists = {};
        let groups = {};
        let chartInstance = null;
        let chartType = 'bar';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            loadData();
            updateCurrency();
            refreshUI();
            updateDebugInfo();
            console.log('App initialized');
        });

        // Data management
        function saveData() {
            try {
                const data = {
                    lists: lists,
                    groups: groups,
                    version: '1.0',
                    lastSaved: Date.now()
                };
                localStorage.setItem('spendingTracker', JSON.stringify(data));
                console.log('Data saved successfully');
                updateDebugInfo();
                return true;
            } catch (e) {
                console.error('Error saving data:', e);
                alert('Error saving data: ' + e.message);
                return false;
            }
        }

        function loadData() {
            try {
                const data = localStorage.getItem('spendingTracker');
                console.log('Loading data...', data ? 'Found data' : 'No data found');
                
                if (data) {
                    const parsed = JSON.parse(data);
                    lists = parsed.lists || {};
                    groups = parsed.groups || {};
                    console.log('Data loaded:', Object.keys(lists).length, 'lists,', Object.keys(groups).length, 'groups');
                } else {
                    lists = {};
                    groups = {};
                    console.log('Starting with empty data');
                }
                return true;
            } catch (e) {
                console.error('Error loading data:', e);
                lists = {};
                groups = {};
                return false;
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateDebugInfo() {
            const debugEl = document.getElementById('debug-info');
            if (debugEl) {
                const listCount = Object.keys(lists).length;
                const groupCount = Object.keys(groups).length;
                const totalItems = Object.values(lists).reduce((sum, list) => {
                    return sum + (list.items ? Object.keys(list.items).length : 0);
                }, 0);
                
                debugEl.innerHTML = `
                    Lists: ${listCount} | Groups: ${groupCount} | Items: ${totalItems}<br>
                    Current List: ${currentListId || 'None'} | View: ${currentView}
                `;
            }
        }

        // UI Refresh - centralized function to update all UI elements
        function refreshUI() {
            console.log('Refreshing UI...');
            
            // Always update lists view
            renderLists();
            
            // Update current view
            if (currentView === 'list-detail' && currentListId) {
                renderItems();
                updateBudgetPill();
            }
            
            // Update current tab content
            if (currentTab === 'photos') {
                renderPhotos();
            } else if (currentTab === 'analytics') {
                renderAnalytics();
            }
            
            updateDebugInfo();
            console.log('UI refreshed');
        }

        // Currency detection
        function updateCurrency() {
            const locale = navigator.language || 'en-CA';
            try {
                const formatter = new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: locale.includes('CA') ? 'CAD' : 'USD'
                });
                window.currencyFormatter = formatter;
            } catch (e) {
                window.currencyFormatter = new Intl.NumberFormat('en-CA', {
                    style: 'currency',
                    currency: 'CAD'
                });
            }
        }

        function formatCurrency(amount) {
            return window.currencyFormatter.format(amount || 0);
        }

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('[id$="-tab"]').forEach(tab => tab.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            currentTab = tabName;

            if (tabName === 'photos') {
                renderPhotos();
            } else if (tabName === 'analytics') {
                renderAnalytics();
            }
        }

        // Lists management
        function renderLists() {
            console.log('Rendering lists...');
            const container = document.getElementById('lists-container');
            if (!container) return;
            
            container.innerHTML = '';

            // Render groups
            Object.values(groups).forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `
                    <div class="list-item" onclick="expandGroup('${group.id}')">
                        <h3>üìÅ ${group.name}</h3>
                        <div class="list-meta">
                            <span>${getGroupListCount(group.id)} lists</span>
                            <span>${formatCurrency(getGroupTotal(group.id))}</span>
                        </div>
                    </div>
                    <div id="group-${group.id}" class="hidden" style="margin-left: 20px;">
                        ${getGroupLists(group.id).map(list => renderListItem(list)).join('')}
                    </div>
                `;
                container.appendChild(groupDiv);
            });

            // Render ungrouped lists
            Object.values(lists).filter(list => !list.groupId).forEach(list => {
                const listDiv = document.createElement('div');
                listDiv.innerHTML = renderListItem(list);
                container.appendChild(listDiv);
            });
            
            console.log('Lists rendered');
        }

        function renderListItem(list) {
            const total = getListTotal(list.id);
            const itemCount = list.items ? Object.keys(list.items).length : 0;
            
            return `
                <div class="list-item" onclick="selectList('${list.id}')">
                    <h3>${list.name}</h3>
                    <div class="list-meta">
                        <span>${itemCount} items</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>
            `;
        }

        function selectList(listId) {
            console.log('Selecting list:', listId);
            currentListId = listId;
            currentView = 'list-detail';
            document.getElementById('lists-view').classList.add('hidden');
            document.getElementById('list-detail-view').classList.remove('hidden');
            document.getElementById('header-title').textContent = lists[listId].name;
            updateBudgetPill();
            renderItems();
            updateDebugInfo();
        }

        function backToLists() {
            console.log('Going back to lists');
            currentListId = null;
            currentView = 'lists';
            document.getElementById('lists-view').classList.remove('hidden');
            document.getElementById('list-detail-view').classList.add('hidden');
            document.getElementById('header-title').textContent = 'Spending Tracker';
            updateBudgetPill();
            updateDebugInfo();
        }

        function getListTotal(listId) {
            const list = lists[listId];
            if (!list || !list.items) return 0;
            return Object.values(list.items).reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
        }

        function getGroupListCount(groupId) {
            return Object.values(lists).filter(list => list.groupId === groupId).length;
        }

        function getGroupTotal(groupId) {
            return Object.values(lists)
                .filter(list => list.groupId === groupId)
                .reduce((sum, list) => sum + getListTotal(list.id), 0);
        }

        function getGroupLists(groupId) {
            return Object.values(lists).filter(list => list.groupId === groupId);
        }

        function expandGroup(groupId) {
            const groupElement = document.getElementById(`group-${groupId}`);
            if (groupElement) {
                groupElement.classList.toggle('hidden');
            }
        }

        // Items management
        function renderItems() {
            console.log('Rendering items for list:', currentListId);
            if (!currentListId) return;
            
            const container = document.getElementById('items-container');
            const list = lists[currentListId];
            if (!container || !list) return;
            
            container.innerHTML = '';

            if (!list.items || Object.keys(list.items).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 40px 0;">No items yet. Add your first item!</p>';
                return;
            }

            Object.values(list.items)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-card';
                    itemDiv.innerHTML = `
                        <div class="item-header">
                            <div class="item-info">
                                <h4>${item.name}</h4>
                                <div class="item-details">
                                    ${formatCurrency(item.price)} √ó ${item.quantity} = 
                                    <span class="item-total">${formatCurrency((item.price || 0) * (item.quantity || 1))}</span>
                                </div>
                                <div class="item-details" style="font-size: 12px; color: #999;">
                                    ${new Date(item.timestamp).toLocaleString()}
                                </div>
                            </div>
                            ${item.photo ? `<img src="${item.photo}" class="item-photo" onclick="showFullscreen('${item.photo}')">` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-secondary btn-small" onclick="editItem('${item.id}')">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('${item.id}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            
            console.log('Items rendered:', Object.keys(list.items).length);
        }

        // Budget management
        function updateBudgetPill() {
            const pill = document.getElementById('budget-pill');
            if (!pill) return;
            
            if (!currentListId) {
                pill.textContent = 'No Budget Set';
                pill.className = 'budget-pill';
                return;
            }

            const list = lists[currentListId];
            const total = getListTotal(currentListId);
            
            if (!list.budget) {
                pill.textContent = 'No Budget Set';
                pill.className = 'budget-pill';
                return;
            }

            const percentage = (total / list.budget) * 100;
            
            if (percentage > 100) {
                pill.textContent = `Over Budget: ${formatCurrency(total)} / ${formatCurrency(list.budget)}`;
                pill.className = 'budget-pill over-budget';
            } else if (percentage > 80) {
                pill.textContent = `Watch Spending: ${formatCurrency(total)} / ${formatCurrency(list.budget)}`;
                pill.className = 'budget-pill watch-spending';
            } else {
                pill.textContent = `On Track: ${formatCurrency(total)} / ${formatCurrency(list.budget)}`;
                pill.className = 'budget-pill on-track';
            }
        }

        // Modal management
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function showFullscreen(imageSrc) {
            document.getElementById('fullscreen-img').src = imageSrc;
            document.getElementById('fullscreen-photo').classList.remove('hidden');
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-photo').classList.add('hidden');
        }

        // Create list modal
        function showCreateListModal() {
            const groupOptions = Object.values(groups).map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            showModal('Create New List', `
                <div class="input-group">
                    <label>List Name</label>
                    <input type="text" id="new-list-name" placeholder="e.g., Weekly Groceries">
                </div>
                <div class="input-group">
                    <label>Group (Optional)</label>
                    <select id="new-list-group">
                        <option value="">No Group</option>
                        ${groupOptions}
                    </select>
                </div>
                <button class="btn" onclick="createList()">Create List</button>
            `);
        }

        function createList() {
            console.log('Creating list...');
            const name = document.getElementById('new-list-name').value.trim();
            const groupId = document.getElementById('new-list-group').value || null;
            
            if (!name) {
                alert('Please enter a list name');
                return;
            }

            const id = generateId();
            lists[id] = {
                id: id,
                name: name,
                groupId: groupId,
                items: {},
                budget: null,
                createdAt: Date.now()
            };

            if (saveData()) {
                refreshUI();
                closeModal();
                console.log('List created successfully:', name);
            }
        }

        // Groups modal
        function showGroupsModal() {
            const groupsList = Object.values(groups).map(g => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin: 10px 0;">
                    <span>${g.name}</span>
                    <button class="btn btn-danger btn-small" onclick="deleteGroup('${g.id}')">Delete</button>
                </div>
            `).join('');

            showModal('Manage Groups', `
                <div class="input-group">
                    <label>New Group Name</label>
                    <input type="text" id="new-group-name" placeholder="e.g., Cuba Vacation">
                </div>
                <button class="btn" onclick="createGroup()">Create Group</button>
                <hr style="margin: 20px 0;">
                <h4>Existing Groups</h4>
                ${groupsList || '<p style="color: #666;">No groups created yet.</p>'}
            `);
        }

        function createGroup() {
            console.log('Creating group...');
            const name = document.getElementById('new-group-name').value.trim();
            if (!name) {
                alert('Please enter a group name');
                return;
            }

            const id = generateId();
            groups[id] = {
                id: id,
                name: name,
                createdAt: Date.now()
            };

            if (saveData()) {
                showGroupsModal(); // Refresh the modal
                console.log('Group created successfully:', name);
            }
        }

        function deleteGroup(groupId) {
            if (!confirm('Delete this group? Lists in the group will become ungrouped.')) return;
            
            console.log('Deleting group:', groupId);
            
            // Remove group from lists
            Object.values(lists).forEach(list => {
                if (list.groupId === groupId) {
                    list.groupId = null;
                }
            });

            delete groups[groupId];
            
            if (saveData()) {
                refreshUI();
                showGroupsModal(); // Refresh the modal
                console.log('Group deleted successfully');
            }
        }

        // Add item modal
        function showAddItemModal() {
            showModal('Add Item', `
                <div class="input-group">
                    <label>Item Name</label>
                    <input type="text" id="item-name" placeholder="e.g., Bananas">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Price</label>
                        <input type="number" id="item-price" step="0.01" placeholder="0.00">
                    </div>
                    <div class="input-group">
                        <label>Quantity</label>
                        <input type="number" id="item-quantity" value="1" min="1">
                    </div>
                </div>
                <div class="input-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="item-photo" accept="image/*">
                </div>
                <button class="btn" onclick="addItem()">Add Item</button>
            `);
        }

        function addItem() {
            console.log('Adding item...');
            const name = document.getElementById('item-name').value.trim();
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
            const photoFile = document.getElementById('item-photo').files[0];

            if (!name) {
                alert('Please enter an item name');
                return;
            }

            const id = generateId();
            const item = {
                id: id,
                name: name,
                price: price,
                quantity: quantity,
                timestamp: Date.now(),
                photo: null
            };

            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    item.photo = e.target.result;
                    finishAddItem(item);
                };
                reader.readAsDataURL(photoFile);
            } else {
                finishAddItem(item);
            }
        }

        function finishAddItem(item) {
            console.log('Finishing add item:', item.name);
            
            if (!lists[currentListId]) {
                console.error('No current list found');
                return;
            }
            
            if (!lists[currentListId].items) {
                lists[currentListId].items = {};
            }
            
            lists[currentListId].items[item.id] = item;
            
            if (saveData()) {
                refreshUI();
                closeModal();
                console.log('Item added successfully:', item.name);
            }
        }

        function editItem(itemId) {
            console.log('Editing item:', itemId);
            if (!lists[currentListId] || !lists[currentListId].items || !lists[currentListId].items[itemId]) {
                console.error('Item not found');
                return;
            }
            
            const item = lists[currentListId].items[itemId];
            showModal('Edit Item', `
                <div class="input-group">
                    <label>Item Name</label>
                    <input type="text" id="edit-item-name" value="${item.name}">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Price</label>
                        <input type="number" id="edit-item-price" step="0.01" value="${item.price}">
                    </div>
                    <div class="input-group">
                        <label>Quantity</label>
                        <input type="number" id="edit-item-quantity" value="${item.quantity}" min="1">
                    </div>
                </div>
                <div class="input-group">
                    <label>Photo</label>
                    <input type="file" id="edit-item-photo" accept="image/*">
                    ${item.photo ? '<p style="font-size: 12px; color: #666;">Current photo will be replaced if you select a new one</p>' : ''}
                </div>
                <button class="btn" onclick="updateItem('${itemId}')">Update Item</button>
            `);
        }

        function updateItem(itemId) {
            console.log('Updating item:', itemId);
            const name = document.getElementById('edit-item-name').value.trim();
            const price = parseFloat(document.getElementById('edit-item-price').value) || 0;
            const quantity = parseInt(document.getElementById('edit-item-quantity').value) || 1;
            const photoFile = document.getElementById('edit-item-photo').files[0];

            if (!name) {
                alert('Please enter an item name');
                return;
            }

            if (!lists[currentListId] || !lists[currentListId].items || !lists[currentListId].items[itemId]) {
                console.error('Item not found for update');
                return;
            }

            const item = lists[currentListId].items[itemId];
            item.name = name;
            item.price = price;
            item.quantity = quantity;

            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    item.photo = e.target.result;
                    finishUpdateItem();
                };
                reader.readAsDataURL(photoFile);
            } else {
                finishUpdateItem();
            }

            function finishUpdateItem() {
                if (saveData()) {
                    refreshUI();
                    closeModal();
                    console.log('Item updated successfully:', item.name);
                }
            }
        }

        function deleteItem(itemId) {
            if (!confirm('Delete this item?')) return;
            
            console.log('Deleting item:', itemId);
            
            if (!lists[currentListId] || !lists[currentListId].items || !lists[currentListId].items[itemId]) {
                console.error('Item not found for deletion');
                return;
            }
            
            delete lists[currentListId].items[itemId];
            
            if (saveData()) {
                refreshUI();
                console.log('Item deleted successfully');
            }
        }

        // Budget modal
        function showBudgetModal() {
            if (!currentListId) return;
            
            const currentBudget = lists[currentListId].budget || '';
            showModal('Set Budget', `
                <div class="input-group">
                    <label>Budget Amount</label>
                    <input type="number" id="budget-amount" step="0.01" value="${currentBudget}" placeholder="Enter budget amount">
                </div>
                <button class="btn" onclick="setBudget()">Set Budget</button>
                <button class="btn btn-secondary" onclick="clearBudget()">Clear Budget</button>
            `);
        }

        function setBudget() {
            const amount = parseFloat(document.getElementById('budget-amount').value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid budget amount');
                return;
            }

            lists[currentListId].budget = amount;
            
            if (saveData()) {
                updateBudgetPill();
                closeModal();
                console.log('Budget set:', amount);
            }
        }

        function clearBudget() {
            lists[currentListId].budget = null;
            
            if (saveData()) {
                updateBudgetPill();
                closeModal();
                console.log('Budget cleared');
            }
        }

        // Photos
        function renderPhotos() {
            console.log('Rendering photos...');
            const container = document.getElementById('photos-container');
            if (!container) return;
            
            container.innerHTML = '';

            const allPhotos = [];
            Object.values(lists).forEach(list => {
                if (list.items) {
                    Object.values(list.items).forEach(item => {
                        if (item.photo) {
                            allPhotos.push({
                                photo: item.photo,
                                name: item.name,
                                listName: list.name,
                                timestamp: item.timestamp
                            });
                        }
                    });
                }
            });

            allPhotos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (allPhotos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 40px 0;">No photos yet. Add items with photos to see them here!</p>';
                return;
            }

            allPhotos.forEach(photo => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.innerHTML = `
                    <img src="${photo.photo}" alt="${photo.name}" onclick="showFullscreen('${photo.photo}')">
                    <div class="photo-item-label">
                        <strong>${photo.name}</strong><br>
                        ${photo.listName}<br>
                        <span style="color: #999;">${new Date(photo.timestamp).toLocaleDateString()}</span>
                    </div>
                `;
                container.appendChild(photoDiv);
            });
            
            console.log('Photos rendered:', allPhotos.length);
        }

        // Analytics
        function renderAnalytics() {
            console.log('Rendering analytics...');
            if (!currentListId) {
                renderGlobalStats();
                renderSpendingChart();
            } else {
                renderListStats();
            }
        }

        function renderListStats() {
            const container = document.getElementById('stats-container');
            if (!container || !currentListId || !lists[currentListId]) return;
            
            const list = lists[currentListId];
            const items = list.items ? Object.values(list.items) : [];
            const total = getListTotal(currentListId);
            const itemCount = items.length;
            const photosCount = items.filter(item => item.photo).length;
            
            const prices = items.map(item => (item.price || 0) * (item.quantity || 1)).filter(price => price > 0);
            const mostExpensive = prices.length > 0 ? Math.max(...prices) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(total)}</div>
                    <div class="stat-label">Total Spent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${itemCount}</div>
                    <div class="stat-label">Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${photosCount}</div>
                    <div class="stat-label">With Photos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(mostExpensive)}</div>
                    <div class="stat-label">Most Expensive</div>
                </div>
            `;
        }

        function renderGlobalStats() {
            const container = document.getElementById('stats-container');
            if (!container) return;
            
            const allItems = [];
            let totalSpent = 0;
            let photosCount = 0;

            Object.values(lists).forEach(list => {
                if (list.items) {
                    Object.values(list.items).forEach(item => {
                        allItems.push(item);
                        totalSpent += (item.price || 0) * (item.quantity || 1);
                        if (item.photo) photosCount++;
                    });
                }
            });

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalSpent)}</div>
                    <div class="stat-label">Total Spent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Object.keys(lists).length}</div>
                    <div class="stat-label">Lists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${allItems.length}</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${photosCount}</div>
                    <div class="stat-label">Photos</div>
                </div>
            `;
        }

        function renderSpendingChart() {
            const ctx = document.getElementById('spending-chart');
            if (!ctx) return;
            
            const context = ctx.getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            const monthlyData = getMonthlySpending();
            
            chartInstance = new Chart(context, {
                type: chartType,
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: monthlyData.values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        fill: chartType === 'line' ? false : true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function getMonthlySpending() {
            const monthlySpending = {};
            
            Object.values(lists).forEach(list => {
                if (list.items) {
                    Object.values(list.items).forEach(item => {
                        const date = new Date(item.timestamp);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (!monthlySpending[monthKey]) {
                            monthlySpending[monthKey] = 0;
                        }
                        monthlySpending[monthKey] += (item.price || 0) * (item.quantity || 1);
                    });
                }
            });

            const sortedKeys = Object.keys(monthlySpending).sort();
            const labels = sortedKeys.map(key => {
                const [year, month] = key.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short'
                });
            });
            const values = sortedKeys.map(key => monthlySpending[key]);

            return { labels, values };
        }

        function toggleChartType() {
            chartType = chartType === 'bar' ? 'line' : 'bar';
            renderSpendingChart();
        }

        function showFilterModal() {
            const listOptions = Object.values(lists).map(list => `
                <div class="checkbox-item">
                    <input type="checkbox" id="list-${list.id}" checked>
                    <label for="list-${list.id}">${list.name}</label>
                </div>
            `).join('');

            showModal('Filter Lists for Chart', `
                <div class="filter-section">
                    <h4>Select Lists to Include</h4>
                    <div class="checkbox-group">
                        ${listOptions}
                    </div>
                </div>
                <button class="btn" onclick="applyChartFilter()">Apply Filter</button>
            `);
        }

        function applyChartFilter() {
            // This is a simplified implementation
            closeModal();
        }

        // Export/Import functions remain the same...
        function exportCurrentList() {
            if (!currentListId) {
                alert('No list selected');
                return;
            }

            const list = lists[currentListId];
            const data = {
                list: list,
                exportDate: Date.now(),
                version: '1.0'
            };

            downloadJSON(data, `${list.name.replace(/[^a-z0-9]/gi, '_')}_export.json`);
        }

        function exportAllData() {
            const data = {
                lists: lists,
                groups: groups,
                exportDate: Date.now(),
                version: '1.0'
            };

            downloadJSON(data, 'spending_tracker_full_export.json');
        }

        function showCSVExportModal() {
            const listOptions = Object.values(lists).map(list => `
                <div class="checkbox-item">
                    <input type="checkbox" id="csv-list-${list.id}" checked>
                    <label for="csv-list-${list.id}">${list.name}</label>
                </div>
            `).join('');

            showModal('Export CSV', `
                <div class="filter-section">
                    <h4>Select Lists to Export</h4>
                    <div class="checkbox-group">
                        ${listOptions}
                    </div>
                </div>
                <button class="btn" onclick="exportCSV()">Export CSV</button>
            `);
        }

        function exportCSV() {
            const selectedLists = [];
            Object.values(lists).forEach(list => {
                const checkbox = document.getElementById(`csv-list-${list.id}`);
                if (checkbox && checkbox.checked) {
                    selectedLists.push(list);
                }
            });

            if (selectedLists.length === 0) {
                alert('Please select at least one list');
                return;
            }

            const csvData = [];
            csvData.push(['List Name', 'Item Name', 'Quantity', 'Unit Price', 'Total', 'Timestamp', 'Has Photo']);

            selectedLists.forEach(list => {
                if (list.items) {
                    Object.values(list.items).forEach(item => {
                        csvData.push([
                            list.name,
                            item.name,
                            item.quantity || 1,
                            item.price || 0,
                            (item.price || 0) * (item.quantity || 1),
                            new Date(item.timestamp).toISOString(),
                            item.photo ? 'Yes' : 'No'
                        ]);
                    });
                }
            });

            const csv = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            downloadFile(csv, 'spending_tracker_export.csv', 'text/csv');
            closeModal();
        }

        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, filename, 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.list) {
                        const newId = generateId();
                        const list = { ...data.list, id: newId };
                        
                        if (list.items) {
                            const newItems = {};
                            Object.values(list.items).forEach(item => {
                                const itemId = generateId();
                                newItems[itemId] = { ...item, id: itemId };
                            });
                            list.items = newItems;
                        }
                        
                        lists[newId] = list;
                        alert('List imported successfully!');
                    } else if (data.lists) {
                        if (confirm('This will merge with your existing data. Continue?')) {
                            Object.values(data.lists || {}).forEach(list => {
                                const newId = generateId();
                                lists[newId] = { ...list, id: newId };
                            });
                            
                            Object.values(data.groups || {}).forEach(group => {
                                const newId = generateId();
                                groups[newId] = { ...group, id: newId };
                            });
                            
                            alert('Data imported successfully!');
                        }
                    }
                    
                    if (saveData()) {
                        refreshUI();
                    }
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('This will permanently delete ALL your data. Are you sure?')) return;
            if (!confirm('This action cannot be undone. Really delete everything?')) return;
            
            lists = {};
            groups = {};
            localStorage.removeItem('spendingTracker');
            
            currentListId = null;
            backToLists();
            refreshUI();
            alert('All data has been cleared');
        }
    </script>
</body>
</html>
